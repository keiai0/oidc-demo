# スコープ定義：OPの責務境界と設計思想

## 1. 認証基盤（OP）の責務とは何か

OIDCにおけるOP（OpenID Provider）の責務は、一言でいうと **「ユーザーが誰であるかを証明すること」** に尽きる。

```
ユーザーが誰であるか  →  OPの責務
ユーザーに何を許可するか  →  RPの責務
ユーザーをどう管理するか  →  RPの責務
```

OPはRPから見ると「信頼できる認証の委託先」であり、RP自身のビジネスロジックや組織構造には関与しない。

---

## 2. OPに含めるべきもの

### 2-1. OIDC標準エンドポイント

OIDCおよびOAuth 2.0仕様で定義されたエンドポイントはOPの本来の責務。

| エンドポイント | 仕様 | 役割 |
|--------------|------|------|
| `/authorize` | OIDC Core | 認可リクエスト受付、認証フロー開始 |
| `/token` | OAuth 2.0 | トークン発行（code, refresh_token） |
| `/userinfo` | OIDC Core | 認証済みユーザーの基本情報提供 |
| `/revoke` | RFC 7009 | トークン失効 |
| `/.well-known/openid-configuration` | OIDC Discovery | OPのメタ情報公開 |
| `/jwks` | OIDC Core | JWT署名検証用公開鍵公開 |
| `/logout` | RP-Initiated Logout | RP起因のログアウト処理 |

### 2-2. 認証フロー

OPが担うべき認証フローの責務範囲。

| 機能 | 含める理由 |
|------|-----------|
| ログイン画面の提供 | ユーザー認証はOPで完結させる |
| パスワード認証 | 認証手段の1つ |
| MFA（TOTP、パスキー等） | 認証強度の向上はOPの責務 |
| セッション管理 | 認証状態の維持はOPが担う |
| パスワードリセット | 認証情報の管理はOPの責務 |
| SSO（シングルサインオン） | 複数RPへの認証委譲 |
| SLO（シングルログアウト） | SSOの対になる責務 |

### 2-3. OP管理機能

OPを運用するために必要な管理機能（OP運用者向け）。

| 機能 | 説明 |
|------|------|
| OIDCクライアント（RP）登録 | どのRPがこのOPを利用できるかの管理 |
| テナント管理 | マルチテナント構成の場合の金融機関・組織単位の設定 |
| JWT署名鍵管理 | 鍵のローテーション、失効 |
| セキュリティインシデント対応 | 全トークン失効、全鍵失効 |

### 2-4. userinfoで返すユーザー属性

OPが管理するのは「認証に必要なユーザーの基本属性」のみ。OIDCの標準クレームに準拠する。

| クレーム | 説明 |
|---------|------|
| `sub` | ユーザーの一意識別子（必須） |
| `name` | 氏名 |
| `email` | メールアドレス |
| `email_verified` | メール認証済みフラグ |
| `updated_at` | 情報更新日時 |

**RP固有の属性（部門、役職、業務上の権限等）はRPが自身のDBで管理し、OPには持たせない。**

---

## 3. OPに含めないもの

ここが最も重要な判断基準。以下はすべてRP側の責務として切り出す。

### 3-1. 判断基準

> **「このデータ・機能は、RPが違えば不要になるか？」**
>
> YESならRP側の責務。OPは汎用的な認証基盤であり、特定RPのビジネス要件に依存してはならない。

### 3-2. 含めないもの一覧

| 機能 | なぜOPに含めないか |
|------|-----------------|
| 企業管理（CRUD） | 企業の組織構造はRP固有のデータ |
| 部門・支店管理 | 組織体系はRP固有のデータ |
| ユーザーのCRUD管理UI | ユーザー台帳の管理はRPの業務 |
| 与信審査・信用スコア | 明らかにRP（金融機関）の業務ロジック |
| 利用規約・プライバシーポリシー管理 | RP固有の法律文書 |
| データImport/Export | RP側のデータ運用業務 |
| 通知設定（メール・SMS等） | RPが独自に管理すべき連絡先情報 |
| ポリシー管理（アクセス制御） | RPが独自に定義すべきアクセス制御 |
| SNS連携（LINE等） | RP固有の連携要件 |

### 3-3. グレーゾーンの判断

「OPとRPどちらが持つか迷う」機能は以下の問いで判断する。

```
Q1: OIDC仕様に定義されているか？
    YES → OP側

Q2: 認証・認可フローの中で必要か？
    NO → RP側

Q3: このOPを使う全RPで共通して必要か？
    NO → RP側（RPが独自に実装）

Q4: RPが違えば実装が変わるか？
    YES → RP側
```

**例: 利用規約への同意**

- OPが「同意済みかどうか」を知る必要はあるか？ → 認証フローでのブロック条件として使うなら関与する
- しかし利用規約の内容管理・バージョン管理・文書自体はRP側の責務
- **OPが持つのは「ユーザーが最新規約に同意済みか否か」のフラグのみ。文書管理はRP側。**

---

## 4. RP側との接合点の設計

OPとRPの境界を明確にした上で、RPが必要なデータをどう取得するかを設計する。

### 4-1. RPがOPから取得できるもの

```
認証後にRPが取得できる情報

ID Token（JWT）:
  - sub（ユーザーID）
  - iss, aud, exp, iat（標準クレーム）
  - email, name（プロフィールスコープ要求時）

userinfo エンドポイント:
  - 上記に加え、OPが管理する基本属性
```

### 4-2. RPがOP側に持たせてはいけないもの

RPは`sub`（ユーザーID）をキーとして自身のDBにRP固有の情報を保持する。OPに「このユーザーの部門は営業1課」のような情報を持たせてはならない。

```
RP側DBの設計例:

users（RP側）
├── op_sub: string        ← OPから取得したsubをキーとして保持
├── department_id
├── role
└── ...RP固有の属性
```

### 4-3. カスタムクレームの扱い

OPにRP固有の属性を持たせたい場合（例: 「このユーザーは管理者か」）は、以下のいずれかで対応する。

1. **スコープ拡張**: RP登録時にカスタムスコープを定義し、トークンにクレームを付与
2. **属性プロバイダー**: RPが別途属性管理サーバーを立て、OPはsubのみ渡す
3. **やらない**: RPがtokenのsubを元に自身のDBから属性を取得する（推奨）

**原則として3を選ぶ。カスタムクレームはOPの複雑性を増やす。**

---

## 5. 膨張しないための設計原則

OPが機能膨張する主な原因と、それを防ぐための原則。

### 原則1: 「認証基盤のついでに」を禁止する

> 「ユーザー情報をOPに持っているから、ついでにユーザー管理画面も作ろう」
> → これが責務越境の始まり。

認証に必要なデータ（ログインID、パスワードハッシュ、MFA設定）とRP業務で必要なデータ（部門、役職）は別テーブル・別サービスで管理する。

### 原則2: RP固有要件はRP側で吸収する

新しいRPから「こういう属性をトークンに入れてほしい」という要求が来ても、OPのモデルを変更するのではなく、RP側でsubを元に自身のDBから取得する設計を推奨する。

### 原則3: OPのユーザーモデルを最小化する

```
OPが管理するusersテーブルに必要なカラム（最小構成）:

- id（OP内でのユーザーID = sub）
- login_id（ログインに使う識別子）
- email（パスワードリセット用）
- email_verified
- status（active/locked/disabled）
- last_login_at
- created_at / updated_at

これ以外の属性はRPが持つ。
```

### 原則4: 管理UIはOPの本質ではない

OPの本質はAPIとしての認証機能。管理UIは「あると便利」であるが、RP業務の管理UIをOPに同梱してはならない。

OPの管理UIに含めるのは:
- OIDCクライアント登録・設定
- テナント設定
- 鍵管理
- インシデント対応

それ以外はRPが自身のシステムに構築する。

---

## 6. KKPPプロジェクトからの教訓

| 問題 | 原因 | 次回への教訓 |
|------|------|-------------|
| 企業管理・部門管理がOPに混入 | RP（銀行）の業務要件をOPで実装してしまった | 設計初期にスコープ定義を文書化し、追加機能は必ずここに照合する |
| ユーザーモデルが肥大化 | 認証属性とRP業務属性が同一テーブル | usersテーブルを認証専用に限定し、RP属性は別テーブル or 別サービス |
| 与信審査・データIOが混入 | 「ついでに」の積み重ね | 機能追加時に「これはOPの責務か？」を必ず問う |
| 全体の約60%がRP業務機能 | 初期のスコープ定義の欠如 | このドキュメントを設計初期に作成・合意する |
